####### PR #### JUICE ####
  - name: pr-test-juice
    build_logs_to_retain: 4
    public: true
    serial: true
    plan:
    - get: pr-juice
      trigger: true
      version: every
{%- for testenv in testenvs %}
{%- for backend in testenv.backends %}
    - get: container-{{ testenv.name }}-{{ backend }}
{% include "tags8.yml" %}
      trigger: true
{% include "tags8.yml" %}
{% endfor %}
{%- endfor %}

    - put: pr-juice-stat
      resource: pr-juice
      get_params:
        skip_download: true
      params:
        path: pr-juice
        base_context: sirmergealot
        context: greenlit
        status: pending
# way too slow, see https://github.com/telia-oss/github-pr-resource/issues/214 for details
# {%- for testenv in testenvs %}
# {%- for backend in testenv.backends %}
#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: coaster-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: coaster-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: coaster-nn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: greenglas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: examples-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: rcudnn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: rcublas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

#     - put: pr-juice-stat
#       resource: pr-juice
#       get_params:
#         skip_download: true
#       params:
#         path: pr-juice
#         base_context: sirmergealot
#         context: rust-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
#         status: pending

# {% endfor %}
# {%- endfor %}

{%- for testenv in testenvs %}
{%- for backend in testenv.backends %}
    - in_parallel:
{% include "parallelism.yml" %}
        fail_fast: false
        steps:
        - task: pr-coaster-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            - path: pr-juice/coaster/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: pr-juice/coaster
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: coaster-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: coaster-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

        - task: pr-coaster-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            - path: pr-juice/coaster-blas/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: pr-juice/coaster-blas
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: coaster-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: coaster-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

        - task: pr-coaster-nn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            - path: pr-juice/coaster-nn/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: pr-juice/coaster-nn
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: coaster-nn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: coaster-nn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

        - task: pr-greenglas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            - path: pr-juice/greenglas/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: pr-juice/greenglas
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: greenglas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: greenglas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

        - task: pr-juice-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: pr-juice/juice
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: juice-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: juice-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

        - task: pr-examples-mackeyglass-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
                cd mackey-glass-rnn-regression
                prepare
{% include "cargo-build.yml" %}
              dir: pr-juice/juice-examples
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: example-mackeyglass-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: example-mackeyglass-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success
{%- match backend.name.as_ref() %}
{%- when "cuda" %}
        - task: pr-example-mnist-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
                cd mnist-image-multiclass-classification
                prepare
{% include "cargo-build.yml" %}
              dir: pr-juice/juice-examples
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: example-mnist-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: example-mnist-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success
{%- else %}
{%- endmatch %}


{%- match backend.name.as_ref() %}
{%- when "native" %}
        - task: pr-rust-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            run:
              path: sh
              args:
              - -exc
              - |
                prepare
                cargo b
                cargo t
              dir: pr-juice/rust-blas
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: rust-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: rust-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

{%- when "cuda" %}
        - task: pr-rcublas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            run:
              path: sh
              args:
              - -exc
              - |
                prepare
                cd cublas-sys
                cargo b
                cargo t
                cd -
                cd cublas
                cargo b
                cargo t
              dir: pr-juice/rcublas
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: rcublas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: rcudnn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success

        - task: pr-rcudnn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: pr-juice
            run:
              path: sh
              args:
              - -exc
              - |
                prepare
                export RUST_LOG=rcublas=trace,cudnn=trace
                cd cudnn-sys
                cargo b
                cargo t
                cd -
                cd cudnn
                cargo b
                cargo t
              dir: pr-juice/rcudnn
          on_failure:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: rcudnn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: failure
          on_success:
            put: pr-juice-stat
            resource: pr-juice
            get_params:
              skip_download: true
            params:
              path: pr-juice
              base_context: sirmergealot
              context: rcudnn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
              status: success
{% else -%}
      # no special treament for {{ backend.name }}
{% endmatch %}

{% endfor %}
{%- endfor %}

        - put: pr-juice-stat
          resource: pr-juice
          params:
            path: pr-juice
            base_context: sirmergealot
            context: greenlit
            status: success
