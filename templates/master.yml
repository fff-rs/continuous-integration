  - name: test-juice
    build_logs_to_retain: 4
    public: true
    serial: true
    plan:
    - get: juice
      trigger: {{ !passive }}
{%- for testenv in testenvs %}
{%- for backend in testenv.backends %}
    - get: container-{{ testenv.name }}-{{ backend }}
      trigger: {{ !passive }}
{% include "tags8.yml" %}
{% endfor %}
{%- endfor %}

{%- for testenv in testenvs %}
{%- for backend in testenv.backends %}

    - in_parallel:
{% include "parallelism.yml" %}
        fail_fast: true
        steps:
        - task: coaster-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            - path: juice/coaster/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: juice/coaster

        - task: coaster-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            - path: juice/coaster-blas/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: juice/coaster-blas

        - task: coaster-nn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            - path: juice/coaster-nn/target
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: juice/coaster-nn

        - task: greenglas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: juice/greenglas

        - task: juice-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
{% include "cargo.yml" %}
              dir: juice/juice

        - task: example-mackeyglass-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
                cd mackey-glass-rnn-regression
                prepare
{% include "cargo-build.yml" %}
              dir: juice/juice-examples

{%- match backend.name.as_ref() -%}
{%- when "cuda" %}
        - task: example-mnist-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
{% include "cargo-config.yml" %}
                cd mnist-image-multiclass-classification
                prepare
{% include "cargo-build.yml" %}
              dir: juice/juice-examples
{%- else %}
{%- endmatch %}

{%- match backend.name.as_ref() -%}
{%- when "native" %}
        - task: rust-blas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            run:
              path: sh
              args:
              - -exc
              - |
                prepare
                cargo build
                cargo test
              dir: juice/rust-blas
{%- when "cuda" %}
        - task: rcudnn-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
                export CARGO_HOME=$(pwd)/../../cargo_home
                mkdir -p ${CARGO_HOME}
                prepare
                export RUST_LOG=rcudnn=trace,rcudnn-sys=trace
                cd cudnn-sys
                cargo build
                cargo test -- --nocapture
                cd -
                cd cudnn
                cargo build
                cargo test -- --nocapture
              dir: juice/rcudnn

        - task: rcublas-{{ backend.execute }}-{{ testenv.name }}-{{ backend }}
          image: container-{{ testenv.name }}-{{ backend }}
{% include "tagsA.yml" %}
          config:
            platform: linux
            inputs:
            - name: juice
            caches:
            - path: cargo_home
            run:
              path: sh
              args:
              - -exc
              - |
                export CARGO_HOME=$(pwd)/../../cargo_home
                mkdir -p ${CARGO_HOME}
                prepare
                export RUST_LOG=rcublas=trace,rcublas-sys=trace
                cd cublas-sys
                cargo build
                cargo test -- --nocapture
                cd -
                cd cublas
                cargo build
                cargo test -- --nocapture
              dir: juice/rcublas
{% else -%}
      # no special treament for {{ backend.name }}
{% endmatch %}

{% endfor -%}
{%- endfor %}
