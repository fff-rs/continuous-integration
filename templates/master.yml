  - name: test-juice
    build_logs_to_retain: 4
    public: true
    serial: true
    plan:
    - in_parallel:
      - get: juice
        trigger: true
{%- for testenv in testenvs %}
{%- for backend in testenv.backends %}
      - get: container-{{ testenv.name }}-{{ backend }}
        trigger: true
{% endfor %}
{%- endfor %}

{%- for testenv in testenvs %}
{%- for backend in testenv.backends %}

{%- if backend.name == "cuda" %}
    - task: {{ backend.execute }}-{{ testenv.name }}-{{ backend }}
      image: container-{{ testenv.name }}-{{ backend }}
{% include "tags.yml" %}
      config:
        platform: linux
        inputs:
        - name: juice
        run:
          path: sh
          args:
          - -exc
          - |
            prepare
            cd cudnn-sys
            cargo build
            cargo build --tests
            cd -
            cd cudnn
            cargo build
            cargo build --tests
          dir: juice/rcudnn

    - task: {{ backend.execute }}-{{ testenv.name }}-{{ backend }}
      image: container-{{ testenv.name }}-{{ backend }}
{% include "tags.yml" %}
      config:
        platform: linux
        inputs:
        - name: juice
        run:
          path: sh
          args:
          - -exc
          - |
            prepare
            cd cublas-sys
            cargo build
            cargo build --tests
            cd -
            cd cublas
            cargo build
            cargo build --tests
          dir: juice/rcublas
{% endif %}

    - task: {{ backend.execute }}-{{ testenv.name }}-{{ backend }}
      image: container-{{ testenv.name }}-{{ backend }}
{% include "tags.yml" %}
      config:
        platform: linux
        inputs:
        - name: juice
        caches:
        - path: target
        run:
          path: sh
          args:
          - -exc
          - |
{% include "cargo-config.yml" -%}
{% include "cargo.yml" %}
          dir: juice/juice
{% endfor %}
{%- endfor %}