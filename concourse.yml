resources:
- name: juice-examples
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/juice-examples.git

- name: juice
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/juice.git

- name: coaster-nn
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/coaster-nn.git

- name: coaster-blas
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/coaster-blas.git

- name: coaster
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/coaster.git

- name: greenglas
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/greenglas.git

- name: rust-cudnn
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/rust-cudnn.git

- name: rust-cublas
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/rust-cublas.git

- name: rust-blas
  type: git
  source:
    branch: master
    uri: https://github.com/spearow/rust-blas.git

- name: container
  type: docker-image
  source:
    repository: quay.io/spearow/machine-learning-container
    username: {{quay-username}}
    password: {{quay-password}}


jobs:
  - name: test-coaster
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: coaster
        trigger: true
      - get: container
        trigger: true
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: coaster
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native"]
          dir: coaster

  - name: test-coaster-cuda
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: coaster
        trigger: true
      - get: container
        trigger: true
      tags: [cuda]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: coaster
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,cuda"]
          dir: coaster

  - name: test-coaster-opencl
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: coaster
        trigger: true
      - get: container
        trigger: true
      tags: [opencl]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: coaster
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: coaster

  - name: test-coaster-default
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: coaster
        trigger: true
      - get: container
        trigger: true
      tags: [opencl,cuda]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: coaster
        run:
          path: cargo
          args: ["test"]
          dir: coaster

  - name: test-coaster-blas
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: rust-blas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native"]
          dir: coaster-blas

  - name: test-coaster-blas-cuda
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: rust-blas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-cuda]
      tags: [cuda]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,cuda"]
          dir: coaster-blas

  - name: test-coaster-blas-opencl
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: rust-blas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-opencl]
      tags: [opencl]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: coaster-blas

  - name: test-coaster-blas-default
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: rust-blas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-default]
      tags: [opencl,cuda]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        run:
          path: cargo
          args: ["test"]
          dir: coaster-blas

  - name: test-coaster-nn
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
        trigger: true
      - get: rust-blas
        trigger: true
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native"]
          dir: coaster-nn

  - name: test-coaster-nn-cuda
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
        trigger: true
      - get: rust-blas
        trigger: true
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-cuda]
      tags: [cuda]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,cuda"]
          dir: coaster-nn

  - name: test-coaster-nn-opencl
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
        trigger: true
      - get: rust-blas
        trigger: true
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-opencl]
      tags: [opencl]
    - task: compile-opencl
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: coaster-nn

  - name: test-coaster-nn-default
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
        trigger: true
      - get: rust-blas
        trigger: true
      - get: rust-cublas
        trigger: true
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-default]
      tags: [cuda,opencl]
    - task: compile-default
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        run:
          path: cargo
          args: ["test"]
          dir: coaster-nn

  - name: test-greenglas
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: greenglas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster, test-coaster-nn, test-coaster-blas]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: greenglas
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native"]
          dir: greenglas

  - name: test-greenglas-cuda
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: greenglas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-cuda, test-coaster-nn-cuda, test-coaster-blas-cuda]
      tags: [cuda]
    - task: compile-cuda
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: greenglas
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,cuda"]
          dir: greenglas

  - name: test-greenglas-opencl
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: greenglas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-opencl, test-coaster-nn-opencl, test-coaster-blas-opencl]
      tags: [opencl]
    - task: compile-opencl
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: greenglas
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: greenglas

  - name: test-greenglas-default
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: greenglas
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-default, test-coaster-nn-default, test-coaster-blas-default]
      tags: [cuda,opencl]
    - task: compile-default
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: greenglas
        run:
          path: cargo
          args: ["test"]
          dir: greenglas

  - name: test-juice
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: juice
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster, test-coaster-nn, test-coaster-blas]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native"]
          dir: coaster-nn

  - name: test-juice-cuda
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: juice
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-cuda, test-coaster-nn-cuda, test-coaster-blas-cuda]
      tags: [cuda]
    - task: compile-cuda
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,cuda"]
          dir: coaster-nn

  - name: test-juice-opencl
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: juice
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-opencl, test-coaster-nn-opencl, test-coaster-blas-opencl]
      tags: [opencl]
    - task: compile-cuda
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: coaster-nn

  - name: test-juice-default
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster
        trigger: true
      - get: coaster-blas
        trigger: true
      - get: coaster-nn
        trigger: true
      - get: juice
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-default, test-coaster-nn-default, test-coaster-blas-default]
      tags: [cuda,opencl]
    - task: compile-opencl
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: coaster-nn

  - name: test-juice-examples
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster-blas
      - get: coaster-nn
      - get: coaster
        trigger: true
      - get: juice
        trigger: true
      - get: juice-examples
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster, test-juice, test-greenglas]
    - task: compile
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        - name: juice-examples
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native"]
          dir: juice-examples

  - name: test-juice-examples-cuda
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster-blas
      - get: coaster-nn
      - get: coaster
        trigger: true
      - get: juice
        trigger: true
      - get: juice-examples
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-cuda, test-juice-cuda, test-greenglas-cuda]
      tags: [cuda]
    - task: compile-cuda
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        - name: juice-examples
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,cuda"]
          dir: juice-examples

  - name: test-juice-examples-opencl
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster-blas
      - get: coaster-nn
      - get: coaster
        trigger: true
      - get: juice
        trigger: true
      - get: juice-examples
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-opencl, test-juice-opencl, test-greenglas-opencl]
      tags: [opencl]
    - task: compile-opencl
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        - name: juice-examples
        run:
          path: cargo
          args: ["test", "--no-default-features","--features=native,opencl"]
          dir: juice-examples

  - name: test-juice-examples-default
    build_logs_to_retain: 20
    public: true
    plan:
    - aggregate:
      - get: rust-cudnn
      - get: rust-blas
      - get: rust-cublas
      - get: coaster-blas
      - get: coaster-nn
      - get: coaster
        trigger: true
      - get: juice
        trigger: true
      - get: juice-examples
        trigger: true
      - get: container
        trigger: true
        passed: [test-coaster-default, test-juice-default, test-greenglas-default]
      tags: [cuda,opencl]
    - task: compile-default
      image: container
      config:
        platform: linux
        inputs:
        - name: rust-cudnn
        - name: rust-blas
        - name: rust-cublas
        - name: coaster
        - name: coaster-blas
        - name: coaster-nn
        - name: juice
        - name: juice-examples
        run:
          path: cargo
          args: ["test"]
          dir: juice-examples
